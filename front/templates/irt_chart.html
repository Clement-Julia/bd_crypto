<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Prices</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body, html { height: 100%; margin: 0; padding: 0; }
        #chart { height: 400px; width: 100%; margin-top: 20px; }
        .price-info { display: flex; align-items: center; justify-content: center; gap: 20px; font-size: 1.5rem; margin-top: 20px; }
        .price-info .price-difference { font-size: 2rem; }
        .price-info .current-price { font-size: 2.5rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mt-4" id="crypto-title">Loading...</h1>
        <div id="chart"></div>
        <div class="price-info">
            <div class="price-difference" id="price-difference"></div>
            <div class="current-price" id="current-price">-- EUR</div>
        </div>
    </div>

    <script type="text/javascript">
        const symbol = window.location.pathname.split('/').pop() + 'EUR';
        $('#crypto-title').text(`Live ${symbol.replace('EUR', '')}/EUR Price`);
        
        var myChart = echarts.init(document.getElementById('chart'));
        var option = {
            title: { text: `${symbol.replace('EUR', '')}/EUR Price Over Time`, left: 'center' },
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'time', boundaryGap: false },
            yAxis: { type: 'value', scale: true, name: 'Price (EUR)' },
            series: [{ name: `${symbol.replace('EUR', '')}/EUR`, type: 'line', data: [] }]
        };
        myChart.setOption(option);
    
        let previousPrice = null;
    
        async function fetchData() {
            try {
                const response = await fetch(`/crypto_prices`, { timeout: 8000 });
                
                if (response.status === 204) {
                    console.warn("No content received from server.");
                    return;
                }
        
                const data = await response.json();
        
                if (data && data.price) {
                    const timestamp = new Date(data.timestamp * 1000).toLocaleString();
                    const price = data.price;
        
                    // Update the chart
                    myChart.setOption({
                        series: [{
                            data: [...myChart.getOption().series[0].data, [new Date(data.timestamp * 1000), price]]
                        }]
                    });
        
                    // Update the displayed price
                    const currentPriceElement = document.getElementById('current-price');
                    currentPriceElement.textContent = `${formatPrice(price.toFixed(2))} EUR`;
        
                    // Calculate and display the price difference
                    const priceDifferenceElement = document.getElementById('price-difference');
                    if (previousPrice !== null) {
                        const difference = price - previousPrice;
                        priceDifferenceElement.innerHTML = difference > 0 
                            ? `<i class="fas fa-arrow-up text-success"></i> ${formatPrice(difference.toFixed(2))} EUR`
                            : difference < 0
                            ? `<i class="fas fa-arrow-down text-danger"></i> ${formatPrice(difference.toFixed(2))} EUR`
                            : `<i class="fas fa-equals text-primary"></i> ${formatPrice(difference.toFixed(2))} EUR`;
                    }
        
                    previousPrice = price;
                } else {
                    console.warn("Invalid data received:", data);
                }
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }
        
        setInterval(fetchData, 5000);
        
        
        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }
                        
    </script>
    
</body>
</html>
